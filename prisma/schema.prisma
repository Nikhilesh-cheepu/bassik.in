// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String        @id // Clerk user ID
  email         String        @unique
  firstName     String?
  lastName      String?
  imageUrl      String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  reservations Reservation[]

  @@index([email])
}

model Venue {
  id             String   @id @default(cuid())
  brandId        String   @unique // Matches brand.id from brands.ts
  name           String
  shortName      String
  address        String
  mapUrl         String?
  contactPhone   String?  // Legacy single number; use contactNumbers when set
  contactNumbers Json?   // [{ "phone": "123", "label": "Main" }]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  images       VenueImage[]
  menus        Menu[]
  offers       VenueOffer[]
  reservations Reservation[]
  discounts    Discount[]

  @@index([brandId])
}

model Discount {
  id           String              @id @default(cuid())
  venueId      String
  title        String
  description  String?
  limitPerDay  Int                 // max slots per day (resets daily)
  startTime    String?             // "12:00" 24h
  endTime      String?             // "18:00" 24h
  session      DiscountSession?    // LUNCH | DINNER | BOTH
  active       Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  venue  Venue                @relation(fields: [venueId], references: [id], onDelete: Cascade)
  usages DiscountDailyUsage[]

  @@index([venueId])
}

model DiscountDailyUsage {
  id         String   @id @default(cuid())
  discountId String
  date       String   // YYYY-MM-DD (venue local)
  usedCount  Int      @default(0)

  discount Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@unique([discountId, date])
  @@index([discountId])
  @@index([discountId, date])
}

enum DiscountSession {
  LUNCH
  DINNER
  BOTH
}

model VenueOffer {
  id        String    @id @default(cuid())
  venueId   String
  imageUrl  String
  endDate   String?   // ISO date string; null = runs indefinitely
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId])
}

model VenueImage {
  id        String    @id @default(cuid())
  venueId   String
  url       String
  type      ImageType // COVER or GALLERY
  order     Int       @default(0) // For ordering images
  createdAt DateTime  @default(now())

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId, type])
  @@index([venueId, type, order])
}

enum ImageType {
  COVER
  GALLERY
}

model Menu {
  id           String   @id @default(cuid())
  venueId      String
  name         String // "Food Menu" or "Liquor Menu"
  thumbnailUrl String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  venue  Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)
  images MenuImage[]

  @@index([venueId])
}

model MenuImage {
  id        String   @id @default(cuid())
  menuId    String
  url       String
  order     Int      @default(0) // For ordering menu pages
  createdAt DateTime @default(now())

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId, order])
}

model Reservation {
  id                String            @id @default(cuid())
  venueId           String
  brandId           String // Keep for quick lookup
  brandName         String
  fullName          String
  contactNumber     String
  numberOfMen       String
  numberOfWomen     String
  numberOfCouples   String
  date              String
  timeSlot          String
  notes             String?
  selectedDiscounts String? // JSON array of discount IDs
  status            ReservationStatus @default(PENDING)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  userId String? // Clerk user ID - optional for backward compatibility
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([venueId])
  @@index([brandId])
  @@index([date])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}
